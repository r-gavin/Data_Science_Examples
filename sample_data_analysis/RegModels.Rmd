---
title: "Automobile Transmissions and Influence on MPG"
author: "Ryan Gavin"
date: "5/10/2017"
output:
  pdf_document:
#    fig_caption: yes
#    fig_width: 5.5
#    fig_height: 5
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      warning = FALSE)
```

## Executive Summary

Fuel efficiency is important to automobile makers and consumers alike. A common measure of fuel efficiency is miles per gallon (**mpg**). In this report, we will aim to answer the following two items:

1. Is an automatic or manual transmission better for MPG?
2. Quantify the MPG difference between automatic and manual transmissions.

We will use the data included in the *mtcars* dataset$^*$ to complete our study. Conducting a Students' *t-test*, we find that cars with **manual** transmissions are more fuel efficient, statistically significantly so (*p-value* $= 0.001374$), than **automatic** transmissions by **7.245 MPG**.

However, cars are complicated machinces with many moving parts. To consider the influence of these confounding variables, we use simple multivariate linear regession to re-evaluate the effect of transmission type on fuel efficiency (mpg). From the analysis found below, by including the features `wt`, `hp`, `cyl` as well as `am`, we find an increase of only **1.478 MPG**. Although this is a smaller increase (yet still statistically significant), this multivariate model better describes the variation in `mpg` by **two and a half times** than the model consisting of only one regressor, `am`.

## Data Processing

```{r libraries, echo=FALSE}
library(ggplot2)
library(caret)
library(car)
library(dplyr)
require(grid)
require(gridExtra)
```

Import `mtcars` dataset, convert it to a tibble (personal preference), and convert `am` to a *factor* variable.

```{r}
data("mtcars")
mtcars <- tbl_df(mtcars)
mtcars2 <- mtcars
mtcars2$am <- as.factor(mtcars$am)
levels(mtcars2$am) <- c("Automatic", "Manual")
```

## Exploratory Analysis

First, we create a boxplot (Fig. A) showing `mpg` and transmission type (`am`) since we are looking at the relationship between `mpg` and `am`. Is there a *statistically* significant difference in `mpg` per `am`? Looking at the average `mpg` for each transmission type and the distribution of `mpg` for each `am` (Fig. B), we can begin to gain some insight and think about how to move forward in our analysis.

```{r}
summarize(group_by(mtcars2,am),avg_mpg = mean(mpg))
```

```{r figures1, echo=FALSE}
g1 <- ggplot(mtcars2,aes(x=am,y=mpg,group=am)) +
      geom_boxplot() + 
      labs(title = "MTCARS Dataset: Miles per Gallon (MPG) Boxplot", 
           subtitle = "MPG for Automatic or Manual Transmissions",
           caption="Fig. A",x="Transmission Type",y="MPG") + 
#      theme_bw(title = element_text(size = 7)) +
      theme_bw(base_size = 6.9)
g2 <- ggplot(mtcars2,aes(x=mpg)) + 
      geom_histogram(aes(y=..density..),binwidth = 2.25) + 
      geom_density() +
      facet_grid(.~am) +
      labs(title = "MTCARS Dataset: Miles per Gallon (MPG) Histograms", 
           subtitle = "MPG Distributions for Automatic or Manual Transmissions",
           caption="Fig. B",x="MPG",y="Density") + 
#      theme(title = element_text(size = 7)) + 
      theme_bw(base_size = 6.9)
grid.arrange(grobs = c(list(g1), list(g2)),
             layout_matrix = rbind(c(1,2),c(1,2)))
```

The distributions look relatively normal around their respective means, so we'll use Students' t-test to find the statistical significance.

## Hypothesis Testing

With an $\alpha = 0.05$, we run the t-test:
```{r}
t.test(filter(mtcars2,am=="Automatic")$mpg,filter(mtcars2,am=="Manual")$mpg,
             paired = FALSE,var.equal = FALSE)
```
We see that the null hypothesis is rejected, and there is a statistically significant difference between MPG for automatic and manual transmission. It appears that manual transmissions, on average, get $7.245$ mpg more than automatic transmissions. The resultant *p-value* is $0.001374$. 

## Linear Regression Analysis

We conduct a similar analysis using linear regression.

```{r}
fit1 <- lm(mpg ~ am, data = mtcars)
summary(fit1)
```
Our simple linear regression seems to show what we already know:  
1. *y*-intercept = average mpg for automatic transmissions  
2. *slope* = average mpg increase when going from automatic transmission to manual  

However, $R^2 = 0.3598$. This tells us that the variable `am` only explains ~36% of the variation in `mpg`. In some respect, this should make sense. The "type of transmission" is only *one* variable that can influence miles per gallon. Therefore, we should expand our analysis to include any confounding variables to help explain the variation in `mpg`.

## Multivariate Regression Analysis

First, let's examine the correlation between various factors and `mpg` (Fig. C), as well as factors and `am` (Fig. D). Correlations have been arranged from greatest to least.
```{r }
cor_list_mpg <- cor(mtcars)[order(desc(abs(cor(mtcars)[,1]))),1][-1]
cor_list_am <- cor(mtcars)[order(desc(abs(cor(mtcars)[,9]))),9][-1]
```
In building our model, we want to include variables that are highly correlated with `mpg`, but also those that are uncorrelated with `am`. This is because variables that we include that are highly correlated with the transmission type introduces unnecessary linear dependence between regressors.

So, we start with the 5 most correlated variables to `mpg` (`wt`, `cyl`, `disp`, `hp`, `drat`) and the 5 least correlated variables to `am` (`carb`, `vs`, `qsec`, `hp`, `cyl`) and pick those that overlap: `cyl` and `hp`. Given the high correlation between `wt` and `mpg` (-0.8676594), we choose to include `wt` as well.

```{r}
fit2 <- lm(mpg ~ am + cyl + hp + wt, data = mtcars)
```

```{r,echo=FALSE}
g3 <- ggplot(data=data.frame(vars = factor(names(cor_list_mpg),levels = names(cor_list_mpg)),
                            corr = cor_list_mpg),
            aes(x=vars,y=corr)) +
      geom_bar(stat = "identity") + 
      labs(title = "MTCARS: Correlations with MPG", caption = "Fig. C",
           x = "MTCARS Dataset Variables", y = "Correlation") + 
      theme_bw(base_size = 7.5)
g4 <- ggplot(data=data.frame(vars = factor(names(cor_list_am),levels = names(cor_list_am)),
                            corr = cor_list_am),
            aes(x=vars,y=corr)) +
      geom_bar(stat = "identity") + 
      labs(title = "MTCARS: Correlations with Transmission", caption = "Fig. D",
           x = "MTCARS Dataset Variables", y = "Correlation") + 
      theme_bw(base_size = 7.5)
grid.arrange(grobs = c(list(g3), list(g4)),
             layout_matrix = rbind(c(1,2),c(1,2)))
```

We now have two models that were constructed with the same data. Let's perform an **ANOVA** to compare the models.
```{r, echo=FALSE}
anova(fit1,fit2)
```
Clearly the multivariate model does a statistically significant better job of fitting the data (*p*-value = 1.274e-08). The summary of our multivariate model tells us that the average increase in miles per gallon when going from automatic to manual transmission is **1.478 MPG**. Our model also does a nice job of describing the variation in `mpg`, with an $R^2$ value of 0.849.
```{r}
summary(fit2)
```
### Model Diagnostics
```{r}
par(mfrow = c(2,2))
plot(fit2)
```
--------------------------
$^*$ The data was extracted from the 1974 Motor Trend US magazine, and comprises fuel consumption and 10 aspects of automobile design and performance for 32 automobiles (1973–74 models).
Henderson and Velleman (1981), Building multiple regression models interactively. *Biometrics*, **37**, 391–411.


